<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Family History Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Leaflet CSS/JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .sidebar {
      position: absolute; z-index: 1000; top: 10px; left: 10px;
      background: white; padding: 10px 12px; border-radius: 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,.15); max-width: 340px; font: 14px/1.3 system-ui, sans-serif;
    }
    .legend { margin-top: 8px; font-size: 13px; }
    .legend div { margin: 4px 0; display:flex; align-items:center; gap:6px; }
    .swatch { width:14px; height:14px; border-radius:3px; border:1px solid #3333; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="sidebar">
    <strong>Family History Map</strong>
    <div>Click points/lines to see details. Use the layer toggle (top-right).</div>
    <div id="updated" class="legend"></div>
    <div id="eraLegend" class="legend"></div>
  </div>

  <script>
    // --- Popup helpers (adjust field names to yours if different) ---
    function popupForPerson(p) {
      const name = p.primary_name || p.name || "Unknown";
      const b = p.birth_year ? `b. ${p.birth_year}` : "";
      const d = p.death_year ? `d. ${p.death_year}` : "";
      const life = (b || d) ? `(${[b, d].filter(Boolean).join(" – ")})` : "";
      const birthPlace = p.birth_place_name ? `<div><b>Birth place:</b> ${p.birth_place_name}</div>` : "";
      const deathPlace = p.death_place_name ? `<div><b>Death place:</b> ${p.death_place_name}</div>` : "";
      return `<div><b>${name}</b> ${life}</div>${birthPlace}${deathPlace}`;
    }
    function popupForPlace(p) {
      const name = p.place_name || p.name || "Place";
      const type = p.place_type ? ` (${p.place_type})` : "";
      return `<div><b>${name}${type}</b></div>`;
    }
    function popupForEvent(p) {
      const type = p.event_type || "Event";
      const year = p.event_year ? ` (${p.event_year})` : "";
      const desc = p.description ? `<div>${p.description}</div>` : "";
      return `<div><b>${type}${year}</b>${desc}</div>`;
    }
    function popupForEraLine(p) {
      const who = p.primary_name || p.person_name || "Person";
      const era = p.era || p.Era || "Era";
      const b = p.birth_year ? `b. ${p.birth_year}` : "";
      const d = p.death_year ? `d. ${p.death_year}` : "";
      const life = (b || d) ? ` (${[b, d].filter(Boolean).join(" – ")})` : "";
      return `<div><b>${who}</b>${life}<div><b>Era:</b> ${era}</div></div>`;
    }

    // --- Map & base layer ---
    const map = L.map("map").setView([41.9, -87.65], 5);
    const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    const baseLayers = { "OpenStreetMap": osm };
    const overlays = {};
    L.control.layers(baseLayers, overlays, { collapsed: false }).addTo(map);

    // Data last updated (best effort)
    fetch("data/places.geojson", { method: "HEAD" })
      .then(r => {
        const d = r.headers.get("last-modified");
        if (d) document.getElementById("updated").textContent =
          `Data last updated: ${new Date(d).toLocaleString()}`;
      }).catch(()=>{});

    // --- Styles ---
    const pointStyle = { radius: 6, weight: 1, color: "#333", fillOpacity: 0.85 };
    const birthStyle = { radius: 6, weight: 1, color: "#0066cc", fillOpacity: 0.9 };
    const deathStyle = { radius: 6, weight: 1, color: "#cc0000", fillOpacity: 0.9 };
    const eventStyle = { color: "#ff6b6b", weight: 2, opacity: 0.9 };

    const eraColors = {
      "Early Republic": "#d9534f",
      "Gilded Age": "#f0ad4e",
      "Colonial Era": "#5cb85c",
      "Civil War & Reconstruction": "#5bc0de",
      "Progressive Era & WWI": "#337ab7",
      "Roaring 20s & Great Depression": "#8e44ad"
    };
    const eraColor = era => eraColors[era] || "#3742fa";

    // Legend for eras
    const eraLegend = document.getElementById("eraLegend");
    eraLegend.innerHTML = "<b>Birth→Death Lines (Eras)</b>" +
      Object.entries(eraColors).map(([k,v]) =>
        `<div><span class="swatch" style="background:${v}"></span> ${k}</div>`).join("");

    // --- Layers ---

    // People (from Person_Locations → people.geojson)
    fetch("data/people.geojson").then(r => r.json()).then(data => {
      const cluster = L.markerClusterGroup();
      const layer = L.geoJSON(data, {
        pointToLayer: (f, latlng) => L.circleMarker(latlng, pointStyle),
        onEachFeature: (f, l) => l.bindPopup(popupForPerson(f.properties || {}))
      });
      cluster.addLayer(layer);
      overlays["People"] = cluster;
      map.addLayer(cluster);
      fitIfNeeded();
    }).catch(()=>{});

    // Places
    fetch("data/places.geojson").then(r => r.json()).then(data => {
      const layer = L.geoJSON(data, {
        pointToLayer: (f, latlng) => L.circleMarker(latlng, { ...pointStyle, fillOpacity: 0.6 }),
        style: () => ({ color: "#2ed573", weight: 2, opacity: 0.8, fillOpacity: 0.2 }),
        onEachFeature: (f, l) => l.bindPopup(popupForPlace(f.properties || {}))
      });
      overlays["Places"] = layer;
      map.addLayer(layer);
      fitIfNeeded();
    }).catch(()=>{});

    // Events (from Event_Points → events.geojson)
    fetch("data/events.geojson").then(r => r.json()).then(data => {
      const layer = L.geoJSON(data, {
        pointToLayer: (f, latlng) => L.circleMarker(latlng, { ...pointStyle, color: "#b30000" }),
        style: () => eventStyle,
        onEachFeature: (f, l) => l.bindPopup(popupForEvent(f.properties || {}))
      });
      overlays["Events"] = layer;
      map.addLayer(layer);
      fitIfNeeded();
    }).catch(()=>{});

    // Birth points
    fetch("data/birth_points.geojson").then(r => r.json()).then(data => {
      const layer = L.geoJSON(data, {
        pointToLayer: (f, latlng) => L.circleMarker(latlng, birthStyle),
        onEachFeature: (f, l) => {
          const p = f.properties || {};
          l.bindPopup(`<div><b>Birth</b>${p.birth_year ? " ("+p.birth_year+")" : ""}<div>${p.primary_name || p.person_name || ""}</div></div>`);
        }
      });
      overlays["Birth Points"] = layer;
      map.addLayer(layer);
      fitIfNeeded();
    }).catch(()=>{});

    // Death points
    fetch("data/death_points.geojson").then(r => r.json()).then(data => {
      const layer = L.geoJSON(data, {
        pointToLayer: (f, latlng) => L.circleMarker(latlng, deathStyle),
        onEachFeature: (f, l) => {
          const p = f.properties || {};
          l.bindPopup(`<div><b>Death</b>${p.death_year ? " ("+p.death_year+")" : ""}<div>${p.primary_name || p.person_name || ""}</div></div>`);
        }
      });
      overlays["Death Points"] = layer;
      map.addLayer(layer);
      fitIfNeeded();
    }).catch(()=>{});

    // Birth→Death Lines (Eras)
    fetch("data/birth_to_death_lines_eras.geojson").then(r => r.json()).then(data => {
      const layer = L.geoJSON(data, {
        style: f => ({ color: eraColor((f.properties||{}).era), weight: 2.5, opacity: 0.95 }),
        onEachFeature: (f, l) => l.bindPopup(popupForEraLine(f.properties || {}))
      });
      overlays["Birth→Death Lines (Eras)"] = layer;
      map.addLayer(layer);
      fitIfNeeded();
    }).catch(()=>{});

    // --- Fit map to visible layers once (when first layers load) ---
    let fitted = false;
    function fitIfNeeded() {
      if (fitted) return;
      const group = L.featureGroup();
      Object.values(overlays).forEach(l => {
        if (map.hasLayer(l)) {
          if (l.getLayers && l.getLayers().length) {
            l.getLayers().forEach(child => group.addLayer(child));
          } else {
            group.addLayer(l);
          }
        }
      });
      try {
        if (group.getLayers().length) {
          map.fitBounds(group.getBounds().pad(0.15));
          fitted = true;
        }
      } catch (e) {}
    }
  </script>
</body>
</html>
